- name: Setup keychain
        env:
          CERT_PASSWORD: ${{ inputs.certificate_password }}
          KEYCHAIN_PASSWORD: actions
        run: |
          # Create temporary keychain
          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Debug: Check certificate file
          echo "Certificate file info:"
          file cert.p12
          echo "Certificate size: $(ls -lh cert.p12 | awk '{print $5}')"
          
          # Validate password
          if [ -z "$CERT_PASSWORD" ]; then
            echo "❌ ERROR: Certificate password is empty!"
            exit 1
          fi
          
          echo "Password length: ${#CERT_PASSWORD} characters"
          
          # Extract certificate and private key using OpenSSL
          echo "Extracting certificate and private key with OpenSSL..."
          
          # Extract certificate (public part)
          printf '%s' "$CERT_PASSWORD" | openssl pkcs12 -in cert.p12 -clcerts -nokeys -passin stdin -out cert.pem 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ Failed to extract certificate"
            exit 1
          fi
          
          # Extract private key
          printf '%s' "$CERT_PASSWORD" | openssl pkcs12 -in cert.p12 -nocerts -nodes -passin stdin -passout pass: -out key.pem 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ Failed to extract private key"
            exit 1
          fi
          
          echo "✅ Certificate and key extracted successfully"
          
          # Convert to a new P12 without password
          echo "Creating new P12 without password..."
          openssl pkcs12 -export -out cert-nopass.p12 -in cert.pem -inkey key.pem -passout pass:
          
          if [ $? -ne 0 ]; then
            echo "❌ Failed to create new P12"
            exit 1
          fi
          
          echo "✅ New P12 created without password"
          
          # Import the password-less certificate to keychain
          echo "Importing certificate to keychain..."
          security import cert-nopass.p12 \
            -k build.keychain \
            -P "" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -A
          
          IMPORT_EXIT=$?
          
          if [ $IMPORT_EXIT -eq 0 ]; then
            echo "✅ Certificate imported successfully"
          else
            echo "❌ Certificate import failed with exit code: $IMPORT_EXIT"
            exit 1
          fi
          
          # Clean up temporary files
          rm -f cert.pem key.pem cert-nopass.p12
          
          # Set key partition list to allow codesign access
          echo "Configuring keychain access..."
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            build.keychain
          
          # Verify certificate was imported
          echo ""
          echo "Verifying certificate import:"
          security find-identity -p codesigning -v build.keychain
          
          IDENTITY_COUNT=$(security find-identity -p codesigning build.keychain | grep -c "valid identities found" || echo "0")
          if [ "$IDENTITY_COUNT" = "0" ]; then
            echo "❌ No valid signing identities found"
            exit 1
          fi
          
          # Install provisioning profile
          echo ""
          echo "Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Get UUID from provisioning profile
          PROFILE_UUID=$(security cms -D -i profile.mobileprovision | grep -a "UUID" | grep -o "[-A-Z0-9]\{36\}")
          
          if [ -z "$PROFILE_UUID" ]; then
            echo "⚠️ Could not extract profile UUID, using default name"
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          else
            echo "Profile UUID: $PROFILE_UUID"
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          fi
          
          echo ""
          echo "✅ Keychain setup complete"
          echo "Installed profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
