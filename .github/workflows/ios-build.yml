name: Build iOS App

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from Supabase'
        required: true
      xcode_project_url:
        description: 'URL to download Xcode project'
        required: true
      config_url:
        description: 'URL to download config.json'
        required: true
      certificate_url:
        description: 'URL to download certificate'
        required: true
      profile_url:
        description: 'URL to download provisioning profile'
        required: true
      certificate_password:
        description: 'Certificate password'
        required: true
      bundle_id:
        description: 'App bundle ID'
        required: true
      version_number:
        description: 'App version number'
        required: true
      build_number:
        description: 'App build number'
        required: true

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Xcode project template
        run: |
          echo "Downloading template from: ${{ inputs.xcode_project_url }}"
          curl -L -o template.zip "${{ inputs.xcode_project_url }}"
          
          echo "Unzipping template..."
          unzip -q template.zip
          
          echo "Template contents:"
          ls -la
          
          # Find FoldaaApp directory (it will be inside foldaa-ios-builds-main/templates/ios-wrapper/)
          FOLDAA_DIR=$(find . -type d -name "FoldaaApp" | head -n 1)
          
          if [ -z "$FOLDAA_DIR" ]; then
            echo "❌ FoldaaApp directory not found"
            echo "Available directories:"
            find . -type d -maxdepth 3
            exit 1
          fi
          
          echo "✅ Found FoldaaApp at: $FOLDAA_DIR"
          
          # Move FoldaaApp to root for easier access
          mv "$FOLDAA_DIR" ./FoldaaApp
          
          echo "FoldaaApp moved to root:"
          ls -la FoldaaApp/

      - name: Download project config
        run: |
          echo "Downloading config from: ${{ inputs.config_url }}"
          curl -L -o config.json "${{ inputs.config_url }}"
          
          echo "Config downloaded"
          
          # Apply config to project files
          echo "Applying configuration..."
          
          # Extract and apply ViewController.swift
          cat config.json | jq -r '.viewController' > FoldaaApp/ViewController.swift
          
          # Extract and apply Info.plist
          cat config.json | jq -r '.infoPlist' > FoldaaApp/Info.plist
          
          echo "✅ Configuration applied"

      - name: Download certificates
        run: |
          echo "Downloading certificate..."
          curl -L -o cert.p12 "${{ inputs.certificate_url }}"
          
          echo "Downloading provisioning profile..."
          curl -L -o profile.mobileprovision "${{ inputs.profile_url }}"
          
          echo "Certificate size: $(ls -lh cert.p12 | awk '{print $5}')"
          echo "Profile size: $(ls -lh profile.mobileprovision | awk '{print $5}')"

      - name: Setup keychain
        run: |
          # Create temporary keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo "Importing certificate..."
          security import cert.p12 \
            -k build.keychain \
            -P "${{ inputs.certificate_password }}" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          
          # Allow codesign to access keychain
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k actions \
            build.keychain
          
          # Install provisioning profile
          echo "Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo "✅ Keychain setup complete"

      - name: Build IPA
        run: |
          cd FoldaaApp
          
          echo "Building iOS app..."
          echo "Bundle ID: ${{ inputs.bundle_id }}"
          echo "Version: ${{ inputs.version_number }}"
          echo "Build: ${{ inputs.build_number }}"
          
          # Build archive
          xcodebuild clean archive \
            -project FoldaaApp.xcodeproj \
            -scheme FoldaaApp \
            -configuration Release \
            -archivePath build/FoldaaApp.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ inputs.bundle_id }}" \
            MARKETING_VERSION="${{ inputs.version_number }}" \
            CURRENT_PROJECT_VERSION="${{ inputs.build_number }}"
          
          # Export IPA
          echo "Exporting IPA..."
          xcodebuild -exportArchive \
            -archivePath build/FoldaaApp.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates
          
          echo "✅ Build complete"
          ls -lh build/*.ipa

      - name: Upload to Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          IPA_PATH="FoldaaApp/build/FoldaaApp.ipa"
          IPA_NAME="${{ inputs.build_id }}.ipa"
          
          echo "Uploading IPA to Supabase Storage..."
          
          # Upload to Supabase Storage
          curl -X POST \
            "${SUPABASE_URL}/storage/v1/object/ios-builds/${IPA_NAME}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@${IPA_PATH}"
          
          # Get public URL
          IPA_URL="${SUPABASE_URL}/storage/v1/object/public/ios-builds/${IPA_NAME}"
          echo "IPA uploaded to: ${IPA_URL}"
          
          # Update build record
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/ios_builds?id=eq.${{ inputs.build_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"status\":\"completed\",\"ipa_url\":\"${IPA_URL}\",\"build_completed_at\":\"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}"
          
          echo "✅ Build record updated"

      - name: Handle failure
        if: failure()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/ios_builds?id=eq.${{ inputs.build_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"status\":\"failed\",\"error_message\":\"Build failed in GitHub Actions\"}"

      - name: Cleanup
        if: always()
        run: |
          # Delete keychain
          security delete-keychain build.keychain || true
          
          # Remove sensitive files
          rm -f cert.p12 profile.mobileprovision || true
          
          echo "✅ Cleanup complete"
