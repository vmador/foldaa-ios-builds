name: Build iOS App

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from Supabase'
        required: true
      xcode_project_url:
        description: 'URL to download Xcode project'
        required: true
      config_url:
        description: 'URL to download config.json'
        required: true
      certificate_url:
        description: 'URL to download certificate'
        required: true
      profile_url:
        description: 'URL to download provisioning profile'
        required: true
      certificate_password:
        description: 'Certificate password'
        required: true
      bundle_id:
        description: 'App bundle ID'
        required: true
      version_number:
        description: 'App version number'
        required: true
      build_number:
        description: 'App build number'
        required: true

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Xcode project template
        run: |
          echo "Downloading template from: ${{ inputs.xcode_project_url }}"
          
          # Download with verbose output
          curl -L -v -o template.zip "${{ inputs.xcode_project_url }}"
          
          # Check if file was downloaded
          if [ ! -f template.zip ]; then
            echo "❌ template.zip was not created"
            exit 1
          fi
          
          # Check file size
          FILE_SIZE=$(ls -lh template.zip | awk '{print $5}')
          echo "Downloaded file size: $FILE_SIZE"
          
          # Check if it's a valid zip (first 4 bytes should be PK)
          echo "File header (first 20 bytes):"
          xxd -l 20 template.zip
          
          # Try to list contents without extracting
          echo "Attempting to list zip contents:"
          unzip -l template.zip || echo "Failed to list contents"
          
          # If it's HTML (error page), show first 200 bytes
          if file template.zip | grep -q "HTML"; then
            echo "❌ Downloaded file is HTML, not a ZIP!"
            echo "First 200 bytes:"
            head -c 200 template.zip
            exit 1
          fi
          
          echo "Unzipping template..."
          unzip -q template.zip
          
          echo "Template contents:"
          ls -la
          
          # Find FoldaaApp directory
          FOLDAA_DIR=$(find . -type d -name "FoldaaApp" | head -n 1)
          
          if [ -z "$FOLDAA_DIR" ]; then
            echo "❌ FoldaaApp directory not found"
            echo "Available directories:"
            find . -type d -maxdepth 3
            exit 1
          fi
          
          echo "✅ Found FoldaaApp at: $FOLDAA_DIR"
          
          # Move FoldaaApp to root
          mv "$FOLDAA_DIR" ./FoldaaApp
          
          echo "FoldaaApp moved to root:"
          ls -la FoldaaApp/

      - name: Download project config
        run: |
          echo "Downloading config from: ${{ inputs.config_url }}"
          curl -L -o config.json "${{ inputs.config_url }}"
          
          echo "Config downloaded"
          
          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            brew install jq
          fi
          
          # Show config contents
          echo "Config contents:"
          cat config.json
          
          # Apply config to project files
          echo "Applying configuration..."
          
          # Extract values from config
          PWA_URL=$(cat config.json | jq -r '.pwaUrl')
          APP_NAME=$(cat config.json | jq -r '.appName')
          BUNDLE_ID=$(cat config.json | jq -r '.bundleId')
          VERSION=$(cat config.json | jq -r '.version')
          BUILD_NUMBER=$(cat config.json | jq -r '.buildNumber')
          
          echo "PWA URL: $PWA_URL"
          echo "App Name: $APP_NAME"
          echo "Bundle ID: $BUNDLE_ID"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          
          # Replace in ViewController.swift
          sed -i '' "s|{{PWA_URL}}|$PWA_URL|g" FoldaaApp/ViewController.swift
          
          # Replace in Info.plist
          sed -i '' "s|{{APP_NAME}}|$APP_NAME|g" FoldaaApp/Info.plist
          sed -i '' "s|{{BUNDLE_ID}}|$BUNDLE_ID|g" FoldaaApp/Info.plist
          sed -i '' "s|{{VERSION}}|$VERSION|g" FoldaaApp/Info.plist
          sed -i '' "s|{{BUILD_NUMBER}}|$BUILD_NUMBER|g" FoldaaApp/Info.plist
          
          echo "✅ Configuration applied"
          echo "ViewController.swift size: $(ls -lh FoldaaApp/ViewController.swift | awk '{print $5}')"
          echo "Info.plist size: $(ls -lh FoldaaApp/Info.plist | awk '{print $5}')"

      - name: Download certificates
        run: |
          echo "Downloading certificate..."
          curl -L -o cert.p12 "${{ inputs.certificate_url }}"
          
          echo "Downloading provisioning profile..."
          curl -L -o profile.mobileprovision "${{ inputs.profile_url }}"
          
          echo "Certificate size: $(ls -lh cert.p12 | awk '{print $5}')"
          echo "Profile size: $(ls -lh profile.mobileprovision | awk '{print $5}')"

      - name: Setup keychain
        env:
          CERT_PASSWORD: ${{ inputs.certificate_password }}
          KEYCHAIN_PASSWORD: actions
        run: |
          # Create temporary keychain
          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Debug: Check certificate file
          echo "Certificate file info:"
          file cert.p12
          echo "Certificate size: $(ls -lh cert.p12 | awk '{print $5}')"
          
          # Validate password
          if [ -z "$CERT_PASSWORD" ]; then
            echo "❌ ERROR: Certificate password is empty!"
            exit 1
          fi
          
          echo "Password length: ${#CERT_PASSWORD} characters"
          
          # Test certificate with OpenSSL first using stdin to avoid shell escaping
          echo "Testing certificate with OpenSSL..."
          printf '%s' "$CERT_PASSWORD" | openssl pkcs12 -in cert.p12 -noout -passin stdin 2>&1
          OPENSSL_EXIT=$?
          
          if [ $OPENSSL_EXIT -eq 0 ]; then
            echo "✅ OpenSSL can read the certificate"
          else
            echo "❌ OpenSSL cannot read certificate with provided password"
            echo "Exit code: $OPENSSL_EXIT"
            exit 1
          fi
          
          # Import certificate using a temporary password file to avoid shell issues
          echo "Importing certificate to keychain..."
          
          # Create temporary password file
          PASS_FILE=$(mktemp)
          printf '%s' "$CERT_PASSWORD" > "$PASS_FILE"
          
          # Import with password from file
          security import cert.p12 \
            -k build.keychain \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -A \
            -f pkcs12 2>&1
          
          IMPORT_EXIT=$?
          
          # Clean up password file
          rm -f "$PASS_FILE"
          
          if [ $IMPORT_EXIT -eq 0 ]; then
            echo "✅ Certificate imported successfully"
          else
            echo "❌ Certificate import failed with exit code: $IMPORT_EXIT"
            
            # Additional debugging
            echo ""
            echo "Debugging information:"
            echo "1. Checking keychain list:"
            security list-keychains
            
            echo ""
            echo "2. Certificate file details:"
            ls -lh cert.p12
            xxd -l 32 cert.p12
            
            exit 1
          fi
          
          # Set key partition list to allow codesign access
          echo "Configuring keychain access..."
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            build.keychain
          
          # Verify certificate was imported
          echo ""
          echo "Verifying certificate import:"
          security find-identity -p codesigning -v build.keychain
          
          IDENTITY_COUNT=$(security find-identity -p codesigning build.keychain | grep -c "valid identities found" || echo "0")
          if [ "$IDENTITY_COUNT" = "0" ]; then
            echo "❌ No valid signing identities found"
            exit 1
          fi
          
          # Install provisioning profile
          echo ""
          echo "Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Get UUID from provisioning profile
          PROFILE_UUID=$(security cms -D -i profile.mobileprovision | grep -a "UUID" | grep -o "[-A-Z0-9]\{36\}")
          
          if [ -z "$PROFILE_UUID" ]; then
            echo "⚠️ Could not extract profile UUID, using default name"
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          else
            echo "Profile UUID: $PROFILE_UUID"
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision
          fi
          
          echo ""
          echo "✅ Keychain setup complete"
          echo "Installed profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build IPA
        run: |
          cd FoldaaApp
          
          echo "Building iOS app..."
          echo "Bundle ID: ${{ inputs.bundle_id }}"
          echo "Version: ${{ inputs.version_number }}"
          echo "Build: ${{ inputs.build_number }}"
          
          # Check if project file exists
          if [ ! -f "FoldaaApp.xcodeproj/project.pbxproj" ]; then
            echo "❌ FoldaaApp.xcodeproj not found"
            ls -la
            exit 1
          fi
          
          # Build archive
          echo "Creating archive..."
          xcodebuild clean archive \
            -project FoldaaApp.xcodeproj \
            -scheme FoldaaApp \
            -configuration Release \
            -archivePath build/FoldaaApp.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ inputs.bundle_id }}" \
            MARKETING_VERSION="${{ inputs.version_number }}" \
            CURRENT_PROJECT_VERSION="${{ inputs.build_number }}"
          
          # Check if ExportOptions.plist exists
          if [ ! -f "ExportOptions.plist" ]; then
            echo "Creating ExportOptions.plist..."
            cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>automatic</string>
          </dict>
          </plist>
          EOF
          fi
          
          # Export IPA
          echo "Exporting IPA..."
          xcodebuild -exportArchive \
            -archivePath build/FoldaaApp.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates
          
          echo "✅ Build complete"
          ls -lh build/*.ipa

      - name: Upload to Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          IPA_PATH="FoldaaApp/build/FoldaaApp.ipa"
          IPA_NAME="${{ inputs.build_id }}.ipa"
          
          echo "Uploading IPA to Supabase Storage..."
          echo "IPA path: $IPA_PATH"
          echo "IPA name: $IPA_NAME"
          
          # Check if IPA exists
          if [ ! -f "$IPA_PATH" ]; then
            echo "❌ IPA file not found at $IPA_PATH"
            echo "Available files in build directory:"
            ls -la FoldaaApp/build/
            exit 1
          fi
          
          # Upload to Supabase Storage
          UPLOAD_RESPONSE=$(curl -X POST \
            "${SUPABASE_URL}/storage/v1/object/ios-builds/${IPA_NAME}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@${IPA_PATH}" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
          echo "Upload HTTP code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "❌ Upload failed with code $HTTP_CODE"
            echo "$UPLOAD_RESPONSE"
            exit 1
          fi
          
          # Get public URL
          IPA_URL="${SUPABASE_URL}/storage/v1/object/public/ios-builds/${IPA_NAME}"
          echo "IPA uploaded to: ${IPA_URL}"
          
          # Update build record
          echo "Updating build record..."
          UPDATE_RESPONSE=$(curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/ios_builds?id=eq.${{ inputs.build_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -d "{\"status\":\"completed\",\"ipa_url\":\"${IPA_URL}\",\"build_completed_at\":\"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}" \
            -w "\n%{http_code}")
          
          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
          echo "Update HTTP code: $UPDATE_HTTP_CODE"
          
          if [ "$UPDATE_HTTP_CODE" != "200" ] && [ "$UPDATE_HTTP_CODE" != "204" ]; then
            echo "⚠️ Failed to update build record, but IPA was uploaded"
            echo "$UPDATE_RESPONSE"
          fi
          
          echo "✅ Build completed successfully"

      - name: Handle failure
        if: failure()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Build failed, updating status..."
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/ios_builds?id=eq.${{ inputs.build_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -d "{\"status\":\"failed\",\"error_message\":\"Build failed in GitHub Actions\",\"build_completed_at\":\"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}"

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          
          # Delete keychain
          security delete-keychain build.keychain || true
          
          # Remove sensitive files
          rm -f cert.p12 profile.mobileprovision || true
          
          echo "✅ Cleanup complete"
